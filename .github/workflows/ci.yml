name: Helping Hands Django CI/CD Pipeline

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run migrations
        env:
          DJANGO_SETTINGS_MODULE: helping_hand_core.settings
        run: |
          python manage.py makemigrations --check --dry-run
          python manage.py migrate --run-syncdb

  test:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run migrations
        env:
          DJANGO_SETTINGS_MODULE: helping_hand_core.settings
        run: |
          python manage.py migrate --run-syncdb

      - name: Run Django checks and tests
        env:
          DJANGO_SETTINGS_MODULE: helping_hand_core.settings
        run: |
          python manage.py check
          python manage.py test apps.user_authentication apps.shift_management apps.notifications apps.dashboard_reports --verbosity=2 || echo "Tests completed"
  coverage:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run migrations
        env:
          DJANGO_SETTINGS_MODULE: helping_hand_core.settings
        run: |
          python manage.py migrate --run-syncdb

      - name: Run coverage tests
        env:
          DJANGO_SETTINGS_MODULE: helping_hand_core.settings
        run: |
          echo "ðŸ” Running Django tests with coverage..."
          coverage run --source='apps' manage.py test apps.user_authentication apps.shift_management apps.notifications apps.dashboard_reports --verbosity=2 || true
          coverage report

      - name: Generate HTML Coverage
        run: |
          echo "ðŸ“Š Generating HTML coverage report..."
          coverage html

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          if-no-files-found: error
  lint:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Flake8
        run: |
          echo "ðŸ” Running Flake8 linting..."
          flake8 apps/ helping_hand_core/ --max-line-length=120 --exclude=migrations --count --statistics > flake8-report.txt || true
          cat flake8-report.txt

      - name: Run Pylint
        run: |
          echo "ðŸ” Running Pylint analysis..."
          pylint apps/ --load-plugins=pylint_django --django-settings-module=helping_hand_core.settings --disable=C0111,R0903 --max-line-length=120 --ignore=migrations > pylint-report.txt || true
          cat pylint-report.txt

      - uses: actions/upload-artifact@v4
        with:
          name: lint-report-flake8
          path: flake8-report.txt
      - uses: actions/upload-artifact@v4
        with:
          name: lint-report-pylint
          path: pylint-report.txt

  security:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit

      - name: Run Bandit security scan
        run: |
          echo "ðŸ”’ Running Bandit security scan..."
          bandit -r apps/ helping_hand_core/ -f json -o bandit-report.json -ll || true
          bandit -r apps/ helping_hand_core/ -f txt || true

      - uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: bandit-report.json

  deploy:
    needs: [coverage, lint, security]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Package deployment artifact
        run: |
          echo "ðŸ“¦ Creating deployment package..."
          mkdir -p deployment

          # Copy Django project files
          cp -r helping_hand_core deployment/
          cp -r apps deployment/
          cp -r templates deployment/
          cp -r static deployment/ 2>/dev/null || mkdir -p deployment/static

          # Copy configuration files
          cp manage.py deployment/
          cp requirements.txt deployment/
          cp README.md deployment/ 2>/dev/null || echo "# Helping Hands" > deployment/README.md
          cp pytest.ini deployment/ 2>/dev/null || true

          # Create deployment info
          echo "Build: ${{ github.run_number }}" > deployment/BUILD_INFO.txt
          echo "Commit: ${{ github.sha }}" >> deployment/BUILD_INFO.txt
          echo "Branch: ${{ github.ref_name }}" >> deployment/BUILD_INFO.txt
          echo "Date: $(date -u)" >> deployment/BUILD_INFO.txt

          # Create zip package
          zip -r deployment-package-${{ github.run_number }}.zip deployment/

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package-*.zip
          retention-days: 30

  
  
  